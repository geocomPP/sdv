A practical primer on R and Spatial Data
==================

This section briefly introduces the input data
and how they can be loaded in R. It is a *practical* chapter, 
so R code will be provided that will allow the steps described to 
be reproduced on your own computer.

The first stage, as with most GIS projects, 
is to obtain and load the data. In this case, all the 
data has been uploaded to an on-line repository that provides 
a detailed tutorial to accompany this Chapter:
[github.com/geocomPP/sdvwR](https://github.com/geocomPP/sdvwR). 
Upon visiting this page you will see many files: the pdf file
is the additional tutorial. To download the data, click on the "Download ZIP" 
button on the right, and unpack the folder to a sensible place
on your computer (e.g. the Desktop). Explore the folder and try opening some of the files, 
especially those from the sub-folder entitled "data": these are the input 
files. For those new to R, we provide a more introductory tutorial on the topic
on line (see https://github.com/Robinlovelace/Creating-maps-in-R/: click on the .pdf 
file and then "View Raw"). (Editor: this could also be a stand-alone appendix).

Spatial Data in R
-----------------

In any data analysis project, spatial or otherwise, it is important to
have a strong understanding of the dataset before progressing. 
We will see how data can be loaded into R (ready for the next section) and exported
to other formats.

### Loading spatial data in R

R is able to import a very wide range of spatial data formats thanks to
its interface with the Geospatial Data Abstraction Library (GDAL). 
The `rgdal` package makes this possible and it can be installed and 
loaded by entering `install.packages("rgdal")` and `library(rgdal)`. 
The former only needs to be typed once, as it saves the data from the internet. 
The latter must be typed for each new R session that requires the package.

The world map we use is available from the Natural Earth website and a
slightly modified version of it (entitled "world") is loaded using the following code.
A common problem preventing the data being loaded correctly is that 
R is not in the correct *working directory*. Please refer to xxx if this 
is an issue.

```{r A Basic Map of the World, fig.width = 8, fig.height= 5, warning=FALSE}
wrld <- readOGR("data/", "world")
```

Let's see a sample of the attribute data 

### The structure of spatial data in R

Spatial datasets in R are saved in their own format, defined as 
`Spatial...` classes within the `sp` package. For this reason, 
`sp` is the basic spatial package in R, upon which the others depend. 
Spatial classes range from the basic `Spatial` class to the complex
`SpatialPolygonsDataFrame`: the `Spatial` class contains only two required *slots* [5]:

```{r}
getSlots("Spatial")
```

This tells us that `Spatial` objects must contain a bounding box (`bbox`) and 
a coordinate reference system (CRS) accessed via the function `proj4string`. 
Further details on these can be found by typing `?bbox` and `?proj4string`. 
All other spatial classes in R build on 
this foundation of a bounding box and a projection system (which 
is set automatically to `NA` if it is not known). However, more complex 
classes contain more slots, some of which are lists which contain additional 
lists. To find out the slots of `shf2lds.simple`, for example, we would first 
ascertain its class and then use the `getSlots` command: !!!!I THINK THIS REQUIRES MORE EXPLANATION- MAYBE MOVE THE APPENDIX UP!!!

```{r}
class(shf2lds.simple) # identify the object's class
getSlots("SpatialLinesDataFrame") # find the associated slots
```

The same principles apply to all spatial classes including 
`Spatial* Points`, `Polygons` `Grids` and `Pixels`
as well as associated `*DataFrame` classes. For more information on 
this, see the `sp` documentation: `?Spatial`.

To flatten a `Spatial*` object in R, so it becomes a simple
data frame, the `fortify` function can be used (more on this later).
For most spatial data handling tasks the `Spatial*` object classes are idea, 
as illustrated below.

### Saving and exporting spatial objects

A typical R workflow involves loading the data, processing/analysing the data
and finally exporting the data in a new form. 
`writeOGR`, the 
logical counterpart of `readOGR` is ideal for this task. This is performed using
the following command (in this case we are exporting to an ESRI Shapefile): !!!THE NEED FOR ROW NAMES NEEDS EXPLANATION HERE!!!

```{r}
shf2lds.simple <- SpatialLinesDataFrame(shf2lds.simple, data.frame(row.names = "0", a = 1))
writeOGR(shf2lds.simple, layer = "shf2lds", dsn = "data/", driver = "ESRI Shapefile")
```

```{r, echo=FALSE}
# delete shf2lds file to prevent it causing errors later on
system("rm data/shf2lds*")
```

In the above code, the object was first converted into a spatial dataframe class required
by the `writeOGR` command, before 
being exported as a shapefile entitled shf2lds. Unlike with `readOGR`, the driver must 
be specified, in this case with "ESRI Shapefile" [4]. The simplified GPS data are now available
to other GIS programs for further analysis. Alternatively, 
`save(shf2lds.simple, file = "data/shf2lds.RData")`
will save the object in R's own spatial data format.

### Attribute joins !!!I THINK THE EXAMPLE NEED TO USE MERGE HERE FOR CONSISTENCY AND SIMPLICITY!!!

London Boroughs are official administrative
zones so we can easily join a range of other datasets 
to the polygons in the `lnd` object. We will use the example 
of crime data to illustrate this data availability, which is 
stored in the `data` folder available from this project's github page.

```{r}
load("data/crimeAg.Rdata") # load the crime dataset from an R dataset
```

After the dataset has been explored (e.g. using the `summary` and `head` functions)
to ensure compatibility, it can be joined to `lnd`. We will use the
the `join` function in the `plyr` package but the `merge` function 
could equally be used (remember to type `library(plyr)` if needed).

```{r, echo=FALSE}
library(plyr)
```

`join` requires all joining variables to have the 
same name, which has already been done [7].

```{r, results='hide', message=FALSE}
lnd@data <- join(lnd@data, crimeAg)
```

Take a look at the `lnd@data` object. You should 
see new variables added, meaning the attribute join 
was successful. 


## Summary

To summarise this section, we have learned how to 
perform the crucial tasks of loading and saving spatial datasets 
in R. This should have been surprisingly painless 
considering the dread surrounding some command-line programs 
(watch out for typos!). We have also taken a look inside R's representation 
of spatial data, learned how to manipulate these datasets 
with a simple attribute join. Much more complex procedures are 
possible, but for now we will move on to visualisation by returning to the chapter. 
